var Feed = { getCookie: function (e) { var t = document.cookie.match("\\b" + e + "=([^;]*)\\b"); return t ? t[1] : "" }, send: function (e, t, i) { this.CONFIG.debug && console.log("sending: " + t), null != this.CONFIG.id && (t._id = this.CONFIG.id, t._tm = new Date().getTime(), t._kind = e, void 0 !== i && (i = function () { }), this.socket.emit("send", JSON.stringify(t), i)) }, sendSeat: function (e, t) { try { t = { command: e, roomId: this.settings.client + ":" + this.CONFIG.key + ":" + t.region, clientId: this.CONFIG.id, incSeat: t.row + ":" + t.seat + ":" + t.type }, this.CONFIG.debug && console.log("sending: " + JSON.stringify(t)), null != this.CONFIG.id && this.goConn.send(this.toClientMsgProto(t)) } catch (i) { console.log(i) } }, join: function (e, t) { if (!this.CONFIG || t.region_id != this.CONFIG.current_region_id) try { this.CONFIG && this.CONFIG.id ? (console.log("change request"), this._change(e, t)) : this._join(e, t) } catch (i) { console.log(i) } }, _change: function (e, t) { this.CONFIG.current_region_id = t.region_id; var i = this.settings.client, n = t.key, o = this.CONFIG.current_region_id; this.goConn.send(this.toClientMsgProto({ command: "change", roomId: i + ":" + n + ":" + o, clientId: this.CONFIG.id })) }, _join: function (e, t) { var i = this; this.CONFIG && this.CONFIG.debug && console.log("send join: " + e); var n = function (e) { return '{"_kind": "' + e + '", "org": "' + i.settings.client + (i.getCookie("org_id") || "") + '", "mid": "' + (i.getCookie("init_code") || "") }, o = function (e, t) { i.CONFIG.debug && console.log("join: [" + e + "]"); var o = n(e); "seat" == e && i.socket.emit("join", o + '", "room": "' + i.CONFIG.key + '", "since": "' + i.CONFIG.since + '"}') }; if ("seat" == e && (this.CONFIG.key = t.key), this.CONFIG.current_region_id = t.region_id, this.CONFIG.recv[e] || (this.CONFIG.recv[e] = t.recv), "seat" == e) return this.handleSeatJoinWS(t); if (null == this.CONFIG.id) { var s = ""; "counter" == e && (s = escape(n("counter") + '", "room": "' + escape(t.name || "") + '", "t": "' + escape(document.title || "") + '"}')); var r = io(i.CONFIG.url, { transports: ["websocket"], timeout: 5e3, upgrade: !1, query: { msg: s } }); r.on("connect", function () { i.CONFIG.debug && console.log("connected"), i.socket = r, o(e, t) }), r.on("disconnect", function () { i.CONFIG.debug && console.log("disconnect") }), r.on("joined", function (e) { i.CONFIG.debug && console.log("joined: " + e.id + "," + e.timestamp), i.CONFIG.id = e.id, i.CONFIG.last_message_time = e.timestamp - i.CONFIG.since }), r.on("recv", function (e) { i.CONFIG.debug && console.log("recv: " + e); var t = "object" == typeof e && null !== e ? e : jQuery.parseJSON(e), n = t._id + t._tm; ("seat" != t._kind || t._id != i.CONFIG.id) && !i.CONFIG.recieved[n] && (i.CONFIG.recieved[n] = 1, i.CONFIG.recv[t._kind] && i.CONFIG.recv[t._kind](t)) }), r.on("sys", function (e) { var t = "object" == typeof e && null !== e ? e : jQuery.parseJSON(e); i.CONFIG.debug && console.log(t), "set" === t.cmd && $("#" + t.p1).val(t.p2) }) } else o(e, t) }, handleSeatJoinWS: function (e) { var t = this.settings.client, i = e.key, n = e.region_id, o = this; this.protoLoad(), window.WebSocket ? (this.goConn = new WebSocket(this.CONFIG.seatURL + "?msg=join|" + (t + ":" + i) + ":" + n + "|" + (this.CONFIG.id || "0")), this.goConn.onclose = function (e) { this.CONFIG.debug && console.log("Connection closed!") }, this.goConn.onmessage = function (t) { o.parseIncMsg(o, e, t.data) }) : console.log("No websocket support") }, parseIncMsg: function (e, t, i) { var n, o = e.hubberMsgProtoToJson(e.textEnc.encode(i)); if (!o) { var s = i.split("\n")[0]; s.indexOf("id:") > -1 ? (id = s.substring(s.indexOf(":") + 1), e.CONFIG.id = id, this.CONFIG.debug && console.log("got client id: " + e.CONFIG.id)) : this.CONFIG.debug && console.error("bad msg: " + s); return } for (var r = 0; r < o.seats.length; r++)mapMsg = { type: (n = o.seats[r].split(":"))[2], region: e.CONFIG.current_region_id, seat_id: "r" + n[0] + "s" + n[1], row: n[0], seat: n[1], _id: e.CONFIG.id, _tm: null, _kind: "seat", _room: e.settings.client + "|" + t.key }, e.CONFIG.recv.seat && e.CONFIG.recv.seat(mapMsg) }, toClientMsgProto: function (e) { var t = this.ClientMsg.verify(e); if (t) { console.log(t); return } return this.ClientMsg.encode(this.ClientMsg.create(e)).finish() }, hubberMsgProtoToJson: function (e) { try { var t = this.HubberMsg.decode(e); return this.HubberMsg.toObject(t, { longs: String, enums: String, bytes: String }) } catch (i) { } return null }, protoLoad: function () { var e = this; protobuf.load("/orders/bs2/js/hubber.proto", function (t, i) { !t && (e.CONFIG.debug && console.log("loaded proto file"), e.ClientMsg = i.lookupType("main.ClientMsg"), e.HubberMsg = i.lookupType("main.HubberMsg")) }) }, init: function (e) { this.settings = { client: "" }, window.TextEncoder ? this.textEnc = new TextEncoder : this.textEnc = { encode: function (e) { for (var t = [], i = 0; i < e.length; i++)t.push(e.charCodeAt(i)); return new Uint8Array(t) } }, e && $.extend(this.settings, e), this.CONFIG = { id: null, key: 0, since: 40, recv: {}, last_message_time: 1, url: "", recieved: {}, debug: 0 }, this.CONFIG.url = "wss://proxy3.hvr.co.il/", this.CONFIG.seatURL = "wss://proxy.icmega.co.il/feed2/ws" } };